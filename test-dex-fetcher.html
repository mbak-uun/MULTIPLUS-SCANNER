<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEX Fetcher Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { padding: 1rem; }
        #results-container { max-height: 60vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h3 class="mb-3"><i class="bi bi-tools"></i> DEX Data Fetcher Tester</h3>
        <div class="card card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="chain" class="form-label">Chain</label>
                    <select id="chain" class="form-select">
                        <option value="bsc">BSC</option>
                        <option value="polygon">Polygon</option>
                        <option value="arbitrum">Arbitrum</option>
                        <option value="ethereum">Ethereum</option>
                        <option value="base">Base</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="modal" class="form-label">Modal (USD)</label>
                    <input type="number" class="form-control" id="modal" value="100">
                </div>
                <div class="col-md-6">
                    <label for="tokenSc" class="form-label">Token SC Address</label>
                    <input type="text" class="form-control" id="tokenSc" placeholder="e.g., 0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82">
                </div>
                <div class="col-md-6">
                    <label for="tokenDecimals" class="form-label">Token Decimals</label>
                    <input type="number" class="form-control" id="tokenDecimals" value="18">
                </div>
                <div class="col-md-6">
                    <label for="pairSc" class="form-label">Pair SC Address</label>
                    <input type="text" class="form-control" id="pairSc" placeholder="e.g., 0x55d398326f99059fF775485246999027B3197955">
                </div>
                <div class="col-md-6">
                    <label for="pairDecimals" class="form-label">Pair Decimals</label>
                    <input type="number" class="form-control" id="pairDecimals" value="18">
                </div>
                <div class="col-12">
                    <label class="form-label">Pilih DEX untuk diuji:</label>
                    <div id="dex-checkboxes" class="d-flex flex-wrap gap-3">
                        <!-- Checkbox akan di-generate oleh JavaScript -->
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="checkAllDex">
                            <label class="form-check-label" for="checkAllDex">Pilih Semua</label>
                        </div>
                    </div>
                </div>
            </div>
            <button id="runTest" class="btn btn-primary mt-3">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                Run Test
            </button>
        </div>

        <h4 class="mt-4">Results</h4>
        <div id="results-container" class="card card-body bg-dark-subtle">
            <div id="results">Awaiting test run...</div>
        </div>
    </div>

    <!-- DEPENDENCIES -->
    <!-- Crypto-JS untuk signature OKX DEX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Konfigurasi Aplikasi -->
    <script src="assets/js/config_app.js"></script>
    <!-- Modul yang akan diuji -->
    <script src="assets/js/services/quote-dex.js"></script>

    <script>
        // Simple HTTP Module Wrapper
        const Http = {
            async request(options) {
                const { url, method = 'GET', headers = {}, data = null, responseType = 'json' } = options;
                const fetchOptions = {
                    method,
                    headers: { 'Content-Type': 'application/json', ...headers },
                };
                if (data) {
                    fetchOptions.body = JSON.stringify(data);
                }
                const response = await fetch(url, fetchOptions);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                return responseType === 'json' ? response.json() : response.text();
            }
        };

        // Test Runner Logic
        document.addEventListener('DOMContentLoaded', () => {
            const runButton = document.getElementById('runTest');
            const resultsEl = document.getElementById('results');
            const spinner = runButton.querySelector('.spinner-border');
            const dexCheckboxesContainer = document.getElementById('dex-checkboxes');

            const testerConfig = JSON.parse(JSON.stringify(KONFIG_APLIKASI));
            if (!testerConfig.DEXS) testerConfig.DEXS = {};

            if (!testerConfig.DEXS.dzap) {
                testerConfig.DEXS.dzap = {
                    WARNA: '#056903ff',
                    URL_DEX: 'https://dzap.io/',
                    FETCH_DEX: {
                        PRIMARY: { CEXtoDEX: 'dzap', DEXtoCEX: 'dzap' },
                        ALTERNATIVE: { ENABLE: false, CEXtoDEX: '', DEXtoCEX: '' }
                    }
                };
            }

            if (!testerConfig.DEXS.swoop) {
                testerConfig.DEXS.swoop = {
                    WARNA: '#4186d8ff',
                    URL_DEX: 'https://bzvwrjfhuefn.up.railway.app/swap',
                    FETCH_DEX: {
                        PRIMARY: { CEXtoDEX: 'swoop', DEXtoCEX: 'swoop' },
                        ALTERNATIVE: { ENABLE: false, CEXtoDEX: '', DEXtoCEX: '' }
                    }
                };
            }

            // Generate DEX checkboxes from config
            Object.keys(testerConfig.DEXS).forEach(dexKey => {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input dex-check" type="checkbox" value="${dexKey}" id="dex-${dexKey}" checked>
                    <label class="form-check-label" for="dex-${dexKey}">${dexKey.toUpperCase()}</label>
                `;
                dexCheckboxesContainer.appendChild(div);
            });

            // "Pilih Semua" functionality
            document.getElementById('checkAllDex').addEventListener('change', (e) => {
                document.querySelectorAll('.dex-check').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });


            // Contoh data untuk BSC (CAKE/USDT)
            document.getElementById('chain').value = 'bsc';
            document.getElementById('tokenSc').value = '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82'; // CAKE
            document.getElementById('tokenDecimals').value = 18;
            document.getElementById('pairSc').value = '0x55d398326f99059fF775485246999027B3197955'; // USDT
            document.getElementById('pairDecimals').value = 18;

            runButton.addEventListener('click', async () => {
                spinner.classList.remove('d-none');
                runButton.disabled = true;
                resultsEl.textContent = 'Fetching quotes...';

                // 1. Ambil input dari form
                const chain = document.getElementById('chain').value;
                const modal = parseFloat(document.getElementById('modal').value);
                const mockToken = {
                    chain: chain.toUpperCase(),
                    sc_token: document.getElementById('tokenSc').value,
                    des_token: parseInt(document.getElementById('tokenDecimals').value),
                    sc_pair: document.getElementById('pairSc').value,
                    des_pair: parseInt(document.getElementById('pairDecimals').value),
                    dex: {} // Asumsikan semua DEX aktif untuk token ini
                };

                // 2. Siapkan konfigurasi DEX yang aktif dari checkbox
                const activeDexConfig = {};
                document.querySelectorAll('.dex-check:checked').forEach(checkbox => {
                    const dexKey = checkbox.value;
                    activeDexConfig[dexKey] = true;
                    // Pastikan mock token juga menganggap dex ini aktif
                    mockToken.dex[dexKey] = { status: true };
                });
                
                const mockGlobalSettings = {
                    walletMeta: '0x0000000000000000000000000000000000000000',
                    swoopAggregator: 'odos'
                };

                try {
                    // 3. Buat kerangka tabel terlebih dahulu
                    resultsEl.innerHTML = '';
                    if (Object.keys(activeDexConfig).length === 0) {
                        resultsEl.textContent = 'Tidak ada DEX yang dipilih atau token tidak mendukung DEX yang dipilih.';
                        spinner.classList.add('d-none');
                        runButton.disabled = false;
                        return;
                    }

                    const table = document.createElement('table');
                    table.className = 'table table-sm table-bordered table-hover';
                    table.innerHTML = `
                        <thead class="table-light">
                            <tr class="text-center">
                                <th>DEX</th>
                                <th>CEX <i class="bi bi-arrow-right"></i> DEX <br><small>(Hasil: ${mockToken.sc_token.substring(0, 8)}...)</small></th>
                                <th>Gas Fee (Gwei/USD)</th>
                                <th>DEX <i class="bi bi-arrow-right"></i> CEX <br><small>(Hasil: ${mockToken.sc_pair.substring(0, 8)}...)</small></th>
                                <th>Detail</th>
                            </tr>
                        </thead>
                    `;
                    const tbody = document.createElement('tbody');
                    tbody.id = 'results-tbody'; // Beri ID pada tbody
                    table.appendChild(tbody);
                    resultsEl.appendChild(table);

                    // Buat baris placeholder untuk setiap DEX yang dipilih
                    document.querySelectorAll('.dex-check:checked').forEach(checkbox => {
                        const dexKey = checkbox.value;
                        const row = document.createElement('tr');
                        row.id = `row-${dexKey}`;
                        row.className = 'text-center align-middle';
                        row.innerHTML = `
                            <td class="fw-bold">${dexKey.toUpperCase()}</td>
                            <td colspan="4"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></td>
                        `;
                        tbody.appendChild(row);
                    });

                    // 4. Definisikan callback untuk memperbarui UI
                    const updateUICallback = (dexKey, result) => {
                        const row = document.getElementById(`row-${dexKey}`);
                        if (!row) return;

                        const collapseId = `collapse-${dexKey}`;
                        const detailRowId = `row-${dexKey}-detail`;

                        row.innerHTML = `
                            <td class="fw-bold">${dexKey.toUpperCase()}</td>
                            <td class="${result.toPair?.amountOut ? 'text-success' : 'text-danger'}">${result.toPair?.amountOut ? result.toPair.amountOut.toFixed(6) : 'Error/Null'}</td>
                            <td class="small text-muted">${result.toPair?.gasFee ? result.toPair.gasFee : '-'}</td>
                            <td class="${result.fromPair?.amountOut ? 'text-success' : 'text-danger'}">${result.fromPair?.amountOut ? result.fromPair.amountOut.toFixed(6) : 'Error/Null'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary py-0 px-2" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}" title="Lihat raw response">
                                    <i class="bi bi-code-slash"></i>
                                </button>
                            </td>
                        `;

                        const existingDetailRow = document.getElementById(detailRowId);
                        if (existingDetailRow) {
                            existingDetailRow.remove();
                        }

                        const detailRow = document.createElement('tr');
                        detailRow.id = detailRowId;
                        detailRow.className = 'accordion-row';
                        detailRow.innerHTML = `
                            <td colspan="5" class="p-0">
                                <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#results-tbody">
                                    <div class="accordion-body bg-black p-2">
                                        <div class="row g-2">
                                            <div class="col-12 col-lg-6">
                                                <h6 class="mb-1">Pair → Token Response</h6>
                                                <pre class="small mb-0 text-start" data-response="pairToToken">Loading...</pre>
                                            </div>
                                            <div class="col-12 col-lg-6">
                                                <h6 class="mb-1">Token → Pair Response</h6>
                                                <pre class="small mb-0 text-start" data-response="tokenToPair">Loading...</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        `;

                        row.insertAdjacentElement('afterend', detailRow);

                        const pairToTokenPre = detailRow.querySelector('[data-response="pairToToken"]');
                        const tokenToPairPre = detailRow.querySelector('[data-response="tokenToPair"]');

                        const stringifySafe = (payload) => {
                            if (!payload) return 'No response data.';
                            try {
                                return JSON.stringify(payload, null, 2);
                            } catch (err) {
                                return `Tidak dapat mem-parsing response: ${err.message}`;
                            }
                        };

                        pairToTokenPre.textContent = stringifySafe(result.pairToToken?.rawResponse);
                        tokenToPairPre.textContent = stringifySafe(result.tokenToPair?.rawResponse);
                    };

                    // 5. Inisialisasi dan jalankan proses dengan callback
                    const dexFetcher = new DexDataFetcher(testerConfig, Http, mockGlobalSettings);
                    // Panggil getQuotes tanpa 'await' agar UI tidak terblokir
                    dexFetcher.getQuotes(
                        mockToken,
                        activeDexConfig,
                        { pairToToken: modal, tokenToPair: modal },
                        mockGlobalSettings,
                        updateUICallback
                    )
                        .finally(() => {
                            // Sembunyikan spinner setelah semua proses selesai
                            spinner.classList.add('d-none');
                            runButton.disabled = false;
                        });

                } catch (error) {
                    resultsEl.textContent = `An error occurred:\n${error.stack}`;
                    // Pastikan spinner disembunyikan jika ada error
                    spinner.classList.add('d-none');
                    runButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
