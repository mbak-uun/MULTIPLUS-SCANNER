<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CEX Fetcher Diagnostic Tool</title>
  <style>
    :root { color-scheme: light dark; font-family: system-ui, -apple-system, Segoe UI, sans-serif; }
    body { margin: 0; padding: 1.5rem; background: #111827; color: #e5e7eb; }
    main { max-width: 1400px; margin: 0 auto; background: rgba(17, 24, 39, 0.75); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem; padding: 2rem; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35); backdrop-filter: blur(12px); }
    h1 { margin-top: 0; font-size: 1.9rem; }
    fieldset { border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 0.75rem; margin-bottom: 1.5rem; padding: 1rem 1.25rem 1.5rem; }
    legend { padding: 0 0.5rem; font-weight: 600; color: #93c5fd; }
    label { display: inline-flex; flex-direction: column; margin-right: 1.5rem; margin-bottom: 1rem; font-size: 0.9rem; color: #cbd5f5; }
    input, select { margin-top: 0.35rem; padding: 0.55rem 0.7rem; border-radius: 0.6rem; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(15, 23, 42, 0.75); color: inherit; min-width: 16rem; }
    .actions { display: flex; gap: 0.8rem; margin: 1.5rem 0 0.5rem; }
    button { appearance: none; border: 1px solid rgba(59, 130, 246, 0.7); background: rgba(59, 130, 246, 0.2); color: #bfdbfe; padding: 0.65rem 1.1rem; border-radius: 0.65rem; font-weight: 600; cursor: pointer; transition: background 0.2s ease; }
    button:hover:not(:disabled) { background: rgba(59, 130, 246, 0.35); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    pre { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.8rem; padding: 1rem; overflow: auto; max-height: 300px; white-space: pre-wrap; word-break: break-word; }
    .cex-selection { display: flex; flex-wrap: wrap; gap: 1rem; }
    .cex-selection label { flex-direction: row; align-items: center; gap: 0.5rem; margin: 0; }
    .results-container { margin-top: 1.5rem; }
    .table-wrapper { max-height: 600px; overflow: auto; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid rgba(255, 255, 255, 0.06); padding: 0.5rem 0.7rem; text-align: left; font-size: 0.85rem; vertical-align: middle; }
    th { background: rgba(59, 130, 246, 0.12); position: sticky; top: 0; z-index: 1; }
    tbody tr:nth-child(even) { background: rgba(255, 255, 255, 0.03); }
    .status-pill { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
    .status-on { background-color: #166534; color: #dcfce7; }
    .status-off { background-color: #991b1b; color: #fee2e2; }
    .status-null { background-color: #4b5563; color: #e5e7eb; }
    .text-truncate { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: bottom; }
    .result-header { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; }
    .result-header.success { color: #4ade80; }
    .result-header.error { color: #f87171; }
  </style>
</head>
<body>
  <main>
    <h1>CEX Fetcher Diagnostic Tool</h1>
    <p>Gunakan halaman ini untuk menguji respon API dari setiap CEX menggunakan modul <code>CheckWalletExchanger</code>. Hasil akan ditampilkan dalam tabel di bawah.</p>

    <fieldset>
      <legend>1. Konfigurasi Dasar</legend>
      <label>
        Chain Target
        <select id="chain-select"></select>
      </label>
      <label>
        Proxy Prefix
        <input id="proxy-input" placeholder="https://proxy.example/?" />
      </label>
      <label>
        Timeout (ms)
        <input id="timeout-input" type="number" value="20000" min="1000" step="500" />
      </label>
    </fieldset>

    <fieldset>
      <legend>2. Pilih CEX untuk Diuji</legend>
      <div id="cex-selection" class="cex-selection"></div>
    </fieldset>

    <fieldset>
      <legend>3. Kredensial API (opsional)</legend>
      <p style="margin-top:0; font-size:0.85rem; color:#9ca3af;">Isi hanya untuk CEX yang membutuhkan autentikasi (e.g., BINANCE, MEXC, BYBIT, INDODAX). Biarkan kosong untuk melewati pengujian `fetchCoinList` pada CEX tersebut.</p>
      <div id="credentials-container"></div>
    </fieldset>

    <div class="actions">
      <button id="run-test">Run Test</button>
      <button id="clear-log" type="button">Clear Results</button>
    </div>

    <pre id="log-output">Ready. Pilih CEX dan klik "Run Test" untuk memulai.</pre>

    <div id="results-container" class="results-container"></div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <script src="assets/js/config_app.js"></script>
  <script src="assets/js/mixins/Http.js"></script>
  <script src="assets/js/mixins/CheckWalletExchanger.js"></script>
  <script>
    (function () {
      // DOM Elements
      const chainSelect = document.getElementById('chain-select');
      const proxyInput = document.getElementById('proxy-input');
      const timeoutInput = document.getElementById('timeout-input');
      const cexSelectionContainer = document.getElementById('cex-selection');
      const credentialsContainer = document.getElementById('credentials-container');
      const logOutput = document.getElementById('log-output');
      const resultsContainer = document.getElementById('results-container');
      const runButton = document.getElementById('run-test');
      const clearButton = document.getElementById('clear-log');

      // Initial Config
      const configClone = JSON.parse(JSON.stringify(KONFIG_APLIKASI));
      const chains = Object.keys(configClone.CHAINS || {});
      const allCex = Object.keys(configClone.CEX || {}).sort();
      const authRequired = new Set(['BINANCE', 'MEXC', 'BYBIT', 'INDODAX', 'KUCOIN', 'BITGET']);

      // --- UI Initialization ---

      // Populate Chain Selector
      chains.forEach(chainKey => {
        const option = document.createElement('option');
        option.value = chainKey;
        option.textContent = `${chainKey.toUpperCase()} (${configClone.CHAINS[chainKey]?.NAMA_CHAIN || ''})`;
        chainSelect.appendChild(option);
      });
      if (chains.includes('bsc')) chainSelect.value = 'bsc';

      // Populate Proxy Input
      proxyInput.value = (configClone.PROXY?.PREFIX) || '';

      // Populate CEX Checkboxes and Credential Inputs
      allCex.forEach(cex => {
        // Checkbox
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = cex;
        checkbox.id = `cex-check-${cex}`;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(cex));
        cexSelectionContainer.appendChild(label);

        // Credential Inputs
        if (authRequired.has(cex)) {
            const dataApi = configClone.CEX?.[cex]?.DATA_API || {};
            const apiKey = dataApi.API_KEY || '';
            const apiSecret = dataApi.API_SECRET || '';
            const passphrase = dataApi.PASSPHRASE_API || '';

            const credDiv = document.createElement('div');
            credDiv.innerHTML = `
                <label>
                    ${cex} API Key
                    <input type="text" data-cex="${cex}" data-field="ApiKey" placeholder="API Key untuk ${cex}" value="${apiKey}">
                </label>
                <label>
                    ${cex} API Secret
                    <input type="text" data-cex="${cex}" data-field="ApiSecret" placeholder="API Secret untuk ${cex}" value="${apiSecret}">
                </label>
                ${(cex === 'KUCOIN' || cex === 'BITGET') ? `
                <label>
                    ${cex} Passphrase
                    <input type="text" data-cex="${cex}" data-field="Passphrase" placeholder="Passphrase untuk ${cex}" value="${passphrase}">
                </label>` : ''}
            `;
            credentialsContainer.appendChild(credDiv);
        }
      });

      // --- Helper Functions ---

      function writeLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        logOutput.textContent = `[${timestamp}] ${message}\n${logOutput.textContent}`;
      }

      function createStatusPill(status) {
        const pill = document.createElement('span');
        pill.classList.add('status-pill');
        if (status === true) {
          pill.textContent = 'ON';
          pill.classList.add('status-on');
        } else if (status === false) {
          pill.textContent = 'OFF';
          pill.classList.add('status-off');
        } else {
          pill.textContent = 'N/A';
          pill.classList.add('status-null');
        }
        return pill;
      }

      function formatPrice(value) {
        if (value === null || value === undefined) return '-';
        const num = Number(value);
        if (Number.isNaN(num)) return '-';
        return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 });
      }

      function renderResultTable(cex, data, error) {
        const container = document.createElement('div');
        container.style.marginBottom = '2rem';

        const header = document.createElement('h3');
        header.textContent = `Hasil untuk ${cex}`;
        
        if (error) {
            header.classList.add('result-header', 'error');
            const errorMsg = document.createElement('p');
            errorMsg.textContent = `Error: ${error}`;
            errorMsg.style.color = '#f87171';
            container.appendChild(header);
            container.appendChild(errorMsg);
            resultsContainer.appendChild(container);
            return;
        }

        header.classList.add('result-header', 'success');
        header.textContent += ` (${data.length} koin ditemukan)`;
        container.appendChild(header);

        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-wrapper';
        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Koin</th>
              <th>Nama Token</th>
              <th>SC Token</th>
              <th>Dec</th>
              <th>Fee WD</th>
              <th>Price</th>
              <th>Trade</th>
              <th>DP</th>
              <th>WD</th>
            </tr>
          </thead>
        `;
        const tbody = document.createElement('tbody');

        data.forEach((item, index) => {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${index + 1}</td>
            <td class="text-truncate" title="${item.nama_koin || ''}">${item.nama_koin || '-'}</td>
            <td>${item.nama_token || '-'}</td>
            <td class="text-truncate" title="${item.sc_token || ''}">${item.sc_token || '-'}</td>
            <td>${item.des_token ?? '-'}</td>
            <td>${item.feeWD ?? '-'}</td>
            <td>${formatPrice(item.price)}</td>
          `;
          row.insertCell().appendChild(createStatusPill(item.trade));
          row.insertCell().appendChild(createStatusPill(item.deposit));
          row.insertCell().appendChild(createStatusPill(item.withdraw));
        });

        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        container.appendChild(tableWrapper);
        resultsContainer.appendChild(container);
      }

      // --- Event Listeners ---

      clearButton.addEventListener('click', () => {
        logOutput.textContent = 'Ready.';
        resultsContainer.innerHTML = '';
      });

      runButton.addEventListener('click', async () => {
        runButton.disabled = true;
        logOutput.textContent = '';
        resultsContainer.innerHTML = '';
        writeLog('Memulai pengujian...');

        // Get config from UI
        const chainKey = chainSelect.value;
        const proxy = proxyInput.value.trim();
        const timeout = Number(timeoutInput.value) || 20000;
        const selectedCex = Array.from(document.querySelectorAll('#cex-selection input:checked')).map(cb => cb.value);

        if (selectedCex.length === 0) {
          writeLog('Tidak ada CEX yang dipilih. Pengujian dibatalkan.');
          runButton.disabled = false;
          return;
        }

        // Prepare secrets
        const secrets = {};
        selectedCex.forEach(cex => {
          if (authRequired.has(cex)) {
            secrets[cex] = {
              ApiKey: document.querySelector(`input[data-cex="${cex}"][data-field="ApiKey"]`)?.value.trim(),
              ApiSecret: document.querySelector(`input[data-cex="${cex}"][data-field="ApiSecret"]`)?.value.trim(),
              Passphrase: document.querySelector(`input[data-cex="${cex}"][data-field="Passphrase"]`)?.value.trim() || undefined
            };
          }
        });

        // Prepare config for fetcher
        const injectedConfig = JSON.parse(JSON.stringify(configClone));
        injectedConfig.PROXY = { PREFIX: proxy };

        // Patch Http module with timeout
        const originalRequest = Http.request;
        Http.request = (options) => originalRequest({ timeout, ...options });

        try {
          const fetcher = new CheckWalletExchanger(secrets, injectedConfig, window.Http);

          writeLog(`Mengambil data Harga & Status Trade untuk: ${selectedCex.join(', ')}`);
          const [getPrice, hasTrade] = await Promise.all([
              fetcher.fetchPrices(selectedCex),
              fetcher.fetchTradeStatus(selectedCex)
          ]);
          writeLog('✓ Data Harga & Status Trade berhasil dimuat.');

          for (const cex of selectedCex) {
            writeLog(`-> Memproses ${cex}...`);
            try {
              const coinList = await fetcher.fetchCoinList(cex, chainKey);
              writeLog(`✓ ${cex}: Ditemukan ${coinList.length} koin.`);

              // Enrich with price and trade status
              const enrichedData = coinList.map(item => ({
                ...item,
                price: getPrice(cex, item.nama_token),
                trade: hasTrade(cex, item.nama_token)
              }));

              renderResultTable(cex, enrichedData);

            } catch (error) {
              const errorMessage = error.message || String(error);
              writeLog(`✗ ${cex}: Gagal mengambil coin list. Error: ${errorMessage}`);
              renderResultTable(cex, null, errorMessage);
            }
          }
        } catch (globalError) {
          writeLog(`Terjadi error global: ${globalError.message}`);
        } finally {
          // Restore original Http.request
          Http.request = originalRequest;
          runButton.disabled = false;
          writeLog('Pengujian selesai.');
        }
      });

      // Mock SyncStorage for INDODAX if not present
      if (!window.SyncStorage) {
        window.SyncStorage = { async getAll() { return []; } };
      }

    })();
  </script>
</body>
</html>